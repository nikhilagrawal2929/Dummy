package com.example;

import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.mime.MultipartEntityBuilder;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Iterator;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

public class ShellScriptRunner {
    private static final Logger logger = Logger.getLogger(ShellScriptRunner.class.getName());

    public static void main(String[] args) {
        if (args.length != 1) {
            logger.severe("Usage: java ShellScriptRunner <csv-file-path>");
            System.exit(1);
        }

        String csvFilePath = args[0];
        String apiUrl = "https://app.ccpdev.shared.banksvcs.net/ccp/api/batch/regressionBulkRun";
        String textFilePath = "urls.txt"; // Internally generated text file

        try {
            // Call the API and get the response
            String jsonResponse = callApi(apiUrl, csvFilePath);
            logger.info("API call successful. Response received.");
            
            // Extract URLs from the JSON response
            String urls = extractUrlsFromJson(jsonResponse);
            logger.info("URLs extracted from JSON response.");
            
            // Write the URLs to a text file
            writeUrlsToFile(urls, textFilePath);
            logger.info("URLs written to file: " + textFilePath);
            
            // Run the shell script
            runShellScript(textFilePath);
            logger.info("Shell script executed successfully.");
        } catch (Exception e) {
            logger.log(Level.SEVERE, "An error occurred", e);
        }
    }

    private static String callApi(String apiUrl, String csvFilePath) throws IOException {
        CloseableHttpClient httpClient = HttpClients.createDefault();
        HttpPost uploadFile = new HttpPost(apiUrl);
        MultipartEntityBuilder builder = MultipartEntityBuilder.create();
        builder.addBinaryBody("file", new File(csvFilePath), ContentType.APPLICATION_OCTET_STREAM, "file.csv");

        HttpEntity multipart = builder.build();
        uploadFile.setEntity(multipart);

        logger.info("Sending POST request to API: " + apiUrl);
        CloseableHttpResponse response = httpClient.execute(uploadFile);
        HttpEntity responseEntity = response.getEntity();

        String result = "";
        if (responseEntity != null) {
            try (InputStream instream = responseEntity.getContent()) {
                result = inputStreamToString(instream);
            }
        }
        response.close();
        httpClient.close();
        logger.info("API response received and processed.");
        return result;
    }

    private static String inputStreamToString(InputStream inputStream) throws IOException {
        StringBuilder stringBuilder = new StringBuilder();
        try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) {
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                stringBuilder.append(line).append("\n");
            }
        }
        return stringBuilder.toString();
    }

    private static String extractUrlsFromJson(String jsonResponse) throws IOException {
        ObjectMapper objectMapper = new ObjectMapper();
        JsonNode rootNode = objectMapper.readTree(jsonResponse);
        StringBuilder urls = new StringBuilder();

        Iterator<Map.Entry<String, JsonNode>> fields = rootNode.fields();
        while (fields.hasNext()) {
            Map.Entry<String, JsonNode> entry = fields.next();
            JsonNode valueNode = entry.getValue();
            if (valueNode.has("URL")) {
                urls.append(valueNode.get("URL").asText()).append("\n");
            }
        }
        return urls.toString();
    }

    private static void writeUrlsToFile(String urls, String filePath) throws IOException {
        Files.write(Paths.get(filePath), urls.getBytes());
    }

    private static void runShellScript(String textFilePath) throws IOException, InterruptedException {
        String shellScriptPath = "C:/Thunderhead/ccp-batch/src/main/resources/s3-files-download1.sh";
        ProcessBuilder processBuilder = new ProcessBuilder("bash", shellScriptPath, textFilePath);
        processBuilder.inheritIO();
        logger.info("Executing shell script: " + shellScriptPath);
        Process process = processBuilder.start();
        process.waitFor();
    }
}
